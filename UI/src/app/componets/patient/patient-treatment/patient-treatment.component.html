<div class="container-fluid py-3">
  <app-patient-header [user]="user"></app-patient-header>
  <div class="card patient-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Treatment</h5>
        <div>
          <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
            data-bs-target="#addTreatmentModal" data-id="{{-1}}" (click)="AddNewTreatmentDetails()">
            <i class="bi bi-plus-lg me-1"></i> Add Treatment
          </button>
        </div>
      </div>

      <div class="d-flex gap-3 mb-3 flex-wrap">
        <div class="badge bg-light text-dark p-2">
          <small class="text-muted">Estimated Cost</small>
          <div class="fw-medium">{{treatment?.EstimatedCost || '0.00'}}</div>
        </div>
        <div class="badge bg-light text-dark p-2">
          <small class="text-muted">Actual Cost</small>
          <div class="fw-medium">{{treatment?.ActualCost || '0.00'}}</div>
        </div>
      </div>
      <div class="row mb-3 align-items-start">
        <label for="txtChiefComplaint" class="col-sm-2 col-form-label">Chief Complaint</label>
        <div class="col-sm-10">
          <textarea id="txtChiefComplaint" class="form-control" rows="2" [ngModel]="treatment?.ChiefComplaint" (ngModelChange)="treatment.ChiefComplaint = $event" placeholder="Enter chief complaint"></textarea>
        </div>
      </div>

      <div class="row mb-3 align-items-start">
        <label for="txtClinicalFindings" class="col-sm-2 col-form-label">Clinical Findings</label>
        <div class="col-sm-10">
          <textarea id="txtClinicalFindings" class="form-control" rows="2" [ngModel]="treatment?.ClinicalFindings" (ngModelChange)="treatment.ClinicalFindings = $event"></textarea>
        </div>
      </div>

      <div class="row mb-3 align-items-start">
        <label for="txtDiagnosis" class="col-sm-2 col-form-label">Diagnosis</label>
        <div class="col-sm-10">
          <textarea id="txtDiagnosis" class="form-control" rows="2" [ngModel]="treatment?.Diagnosis" (ngModelChange)="treatment.Diagnosis = $event"></textarea>
        </div>
      </div>

      <div class="row mb-3 align-items-start">
        <label for="txtPrescription" class="col-sm-2 col-form-label">Prescription</label>
        <div class="col-sm-10">
          <textarea id="txtPrescription" class="form-control" rows="2" [ngModel]="treatment?.Prescription" (ngModelChange)="treatment.Prescription = $event"></textarea>
        </div>
      </div>

      <div class="row mb-3 align-items-start">
        <label for="txtTreatmentPlan" class="col-sm-2 col-form-label">Treatment Plan</label>
        <div class="col-sm-10">
          <textarea id="txtTreatmentPlan" class="form-control" rows="2" [ngModel]="treatment?.TreatmentPlan" (ngModelChange)="treatment.TreatmentPlan = $event"></textarea>
        </div>
      </div>

      <input type="hidden" id="txtTreatmentID" value="-1" [ngModel]="treatment?.ID">

      <div class="row mb-3">
        <label for="txtEstimatedCost" class="col-sm-2 col-form-label">Estimated Cost</label>
        <div class="col-sm-3">
          <input type="number" id="txtEstimatedCost" class="form-control" [ngModel]="treatment?.EstimatedCost" (ngModelChange)="treatment.EstimatedCost = $event" placeholder="0.00">
        </div>
        <div class="col-sm-2 d-none d-sm-block"></div>
        <label for="txtActualCost" class="col-sm-2 col-form-label">Actual Cost</label>
        <div class="col-sm-3">
          <input type="number" id="txtActualCost" class="form-control" [ngModel]="treatment?.ActualCost" (ngModelChange)="treatment.ActualCost = $event" placeholder="0.00">
        </div>
      </div>

    <!--Large screen Table-->
    <div class="row d-none d-md-block">
      <div class="col-12">
        <!-- action button moved to card header for better visibility -->
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-sm app-table">
            <thead>
              <tr>
                <th class="w-1"></th>
                <th>Date</th>
                <th>Tooth</th>
                <th>Procedure</th>
                <th>Prescription</th>
                <th>Follow Up</th>
                <th class="text-end">Cost</th>
                <th>Treatment ID</th>
                <th>ID</th>
              </tr>
            </thead>
            <tbody>
              @for (treatmentdetail of treatment?.PatientTreatmentDetails;track treatmentdetail.ID){
              <tr>
                <td class="align-middle">
                  <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal"
                      data-bs-target="#addTreatmentModal"
                      (click)="EditTreatmentDetails(treatmentdetail.ID)" title="Edit Treatment"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" type="button" title="Delete Treatment"
                      (click)="DeleteTreatmentDetails(treatmentdetail.ID)"><i class="bi bi-trash"></i></button>
                  </div>
                </td>
                <td class="align-middle">{{treatmentdetail.TreatmentDate}}</td>
                <td class="align-middle">{{treatmentdetail.Tooth}}</td>
                <td class="align-middle">{{treatmentdetail.Procedure}}</td>
                <td class="align-middle">{{treatmentdetail.Prescription}}</td>
                <td class="align-middle">{{treatmentdetail.FollowUpInstructions}}</td>
                <td class="align-middle text-end">{{treatmentdetail.ProcedureTreatmentCost}}</td>
                <td class="align-middle">{{treatmentdetail.PatientTreatmentID}}</td>
                <td class="align-middle">{{treatmentdetail.ID}}</td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!--Mobile view - stacked cards-->
    <div class="row d-block d-md-none">
      <div class="col-12">
        <div class="cards-view">
          @for (treatmentdetail of treatment?.PatientTreatmentDetails;track $index){
          <div class="result-card p-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">{{treatmentdetail.Procedure || 'Treatment'}}</h6>
                <small class="text-muted">Date: {{treatmentdetail.TreatmentDate}} â€¢ Tooth: {{treatmentdetail.Tooth}}</small>
                <p class="mb-1 mt-2">{{treatmentdetail.Prescription}}</p>
                <p class="mb-0"><strong>Cost:</strong> {{treatmentdetail.ProcedureTreatmentCost}}</p>
              </div>
              <div class="d-flex flex-column align-items-end">
                <button class="btn btn-sm btn-outline-primary mb-2" data-bs-toggle="modal" data-bs-target="#addTreatmentModal" (click)="EditTreatmentDetails(treatmentdetail.ID)"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" (click)="DeleteTreatmentDetails(treatmentdetail.ID)"><i class="bi bi-trash"></i></button>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    </div>
  </div>

<br>

<!-- Modal Add Treatment -->
<div class="modal fade" data-bs-keyboard="false" data-bs-backdrop="static" id="addTreatmentModal" tabindex="-1"
  aria-labelledby="addTreatmentModal" (hidden.bs.modal)="ClearTreatmentForm()">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add Treatment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <br />
        <div class="row">
          <div class="col">
            <label for="txtTreatmentDate" class="form-label">Treatment Date <span style="color: red;">*</span></label>
          </div>
          <div class="col">
            <input type="date" id="txtTreatmentDate" class="form-control" min="2024-01-01" max="2030-12-31"
              [ngModel]="newTreatmentDetail?.TreatmentDate" 
              (ngModelChange)="newTreatmentDetail && (newTreatmentDetail.TreatmentDate = $event)">
          </div>
        </div>
        <br />
        <div class="row">
          <div class="col">
            <label for="txtTooth" class="form-label">Tooth Number <span style="color: red;">*</span></label>
          </div>
          <div class="col">
            <input type="text" id="txtTooth" class="form-control" [ngModel]="newTreatmentDetail?.Tooth"
              (ngModelChange)="newTreatmentDetail && (newTreatmentDetail.Tooth = $event)">
          </div>
        </div>
        <br />
        <div class="row">
          <div class="col">
            <label for="txtProcedure" class="form-label">Tooth Procedure <span style="color: red;">*</span></label>
          </div>
          <div class="col">
            <input type="text" id="txtProcedure" class="form-control" [ngModel]="newTreatmentDetail?.Procedure"
              (ngModelChange)="newTreatmentDetail && (newTreatmentDetail.Procedure = $event)">
          </div>
        </div>
        <br />
        <div class="row">
          <div class="col">
            <label for="txtPrescription" class="form-label">Prescription Medication</label>
          </div>
          <div class="col">
            <textarea id="txtPrescription" class="form-control" rows="2" [ngModel]="newTreatmentDetail?.Prescription"
              (ngModelChange)="newTreatmentDetail && (newTreatmentDetail.Prescription = $event)"></textarea>
          </div>
        </div>
        <br />
        <div class="row">
          <div class="col">
            <label for="txtFollowUpInstructions" class="form-label">Follow Up Instructions</label>
          </div>
          <div class="col">
            <textarea id="txtFollowUpInstructions" class="form-control" rows="2"
              [ngModel]="newTreatmentDetail?.FollowUpInstructions"
              (ngModelChange)="newTreatmentDetail && (newTreatmentDetail.FollowUpInstructions = $event)"></textarea>
          </div>
        </div>
        <br />
         <div class="row">
          <div class="col">
            <label for="txtTreatmentCost" class="form-label">Treatment Cost</label>
          </div>
          <div class="col">
            <input type="number" id="txtTreatmentCost" class="form-control" rows="2"
              [ngModel]="newTreatmentDetail?.ProcedureTreatmentCost"
              (ngModelChange)="newTreatmentDetail && (newTreatmentDetail.ProcedureTreatmentCost = $event)">
          </div>
        </div>
        <br />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" (click)="SaveTreatmentDetails()">Save
          Treatment</button>
      </div>
    </div>
  </div>
</div>